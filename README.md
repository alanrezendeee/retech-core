# retech-core ‚Äî Core APIs for The Retech

Centraliza **servi√ßos utilit√°rios** e **integra√ß√µes p√∫blicas** para acelerar diversos projetos (web, mobile, backoffice). Foco em **estabilidade**, **observabilidade** e **padroniza√ß√£o** de respostas.

---

## ‚ú® Objetivos

* Expor endpoints **est√°veis** para dados p√∫blicos/derivados (UFs, munic√≠pios, RAs do DF, CEP, bancos, feriados etc.).
* **Padronizar** contratos (envelope de resposta, erros RFC 7807) entre projetos.
* **Desacoplar** front-ends das fontes externas (IBGE, BrasilAPI, etc.), com **cache** e **rate limiting**.
* **Observabilidade** pronta (Prometheus + OpenTelemetry) e **resili√™ncia** (retries, circuit breaker).

---

## üìê Arquitetura (resumo)

```
Cliente ‚Üí retech-core (API Gateway utilit√°rio)
            ‚îú‚îÄ /geo/*   ‚Üí (cache + normaliza√ß√£o) ‚Üí IBGE/BrasilAPI/fonte DF
            ‚îú‚îÄ /cep/*   ‚Üí (cache + fallback) ‚Üí ViaCEP/BrasilAPI
            ‚îú‚îÄ /utils/* ‚Üí servi√ßos puros (CPF/CNPJ, phone, currency, slug)
            ‚îú‚îÄ /biz/*   ‚Üí bancos, feriados, etc. (cache)
            ‚îî‚îÄ /health,/metrics,/docs
```

* **Cache**: Redis (TTL configur√°vel).
* **Circuit breaker**: impedir cascata de falhas de upstream.
* **Rate limiting**: token bucket por IP/chave.
* **Auth**: API Key opcional por rota; JWT passthrough quando aplic√°vel.

---

## üì¶ Estrutura de pastas (Go + Gin)

```
retech-core/
  cmd/api/main.go
  internal/
    http/ (rotas, handlers)
    services/ (casos de uso)
    clients/ (ibge, brasilapi, viacep, gdf)
    cache/ (redis)
    config/
    observability/ (otel, prometheus)
    middleware/ (auth, rate-limit, cors, idempotency)
    domain/ (DTOs/validators)
  pkg/
  build/
    Dockerfile
    docker-compose.yml
```

---

## üîê Seguran√ßa

* **API Key** por projeto/cliente (header `x-api-key`).
* **JWT passthrough** (quando consumir servi√ßos internos que exigem identidade).
* **CORS** configur√°vel por ambiente.
* **Auditoria** b√°sica (request-id, caller, rota, status, lat√™ncia).

---

## üìä Observabilidade

* **/metrics** (Prometheus)
* **OpenTelemetry** traces (HTTP client/server)
* **Log estruturado** (JSON; correla√ß√£o por `X-Request-ID`)

---

## üìë Conven√ß√µes de resposta

### Sucesso

```json
{
  "success": true,
  "code": "OK",
  "data": { "..." },
  "meta": { "cache": {"hit": true, "ttl": 300} }
}
```

### Erro (RFC 7807)

```json
{
  "type": "https://retech-core/errors/upstream-timeout",
  "title": "Upstream Timeout",
  "status": 504,
  "detail": "IBGE n√£o respondeu em 5s",
  "instance": "/geo/ufs?q=pern",
  "traceId": "01H..."
}
```

---

## üöÄ Endpoints implementados (v1)

### 0) Infra

* ‚úÖ `GET /health` ‚Üí Verifica sa√∫de da aplica√ß√£o e conex√£o com MongoDB
* ‚úÖ `GET /version` ‚Üí Retorna vers√£o da API
* ‚úÖ `GET /docs` ‚Üí Documenta√ß√£o HTML (Redoc)
* ‚úÖ `GET /openapi.yaml` ‚Üí Especifica√ß√£o OpenAPI

### 1) Tenants

* ‚úÖ `POST /tenants` ‚Üí Criar tenant
* ‚úÖ `GET /tenants` ‚Üí Listar tenants
* ‚úÖ `GET /tenants/:id` ‚Üí Buscar tenant por ID
* ‚úÖ `PUT /tenants/:id` ‚Üí Atualizar tenant
* ‚úÖ `DELETE /tenants/:id` ‚Üí Remover tenant

### 2) API Keys

* ‚úÖ `POST /apikeys` ‚Üí Criar API key
* ‚úÖ `POST /apikeys/revoke` ‚Üí Revogar API key
* ‚úÖ `POST /apikeys/refresh` ‚Üí Rotacionar API key

### 3) GEO (Estados e Munic√≠pios)

* ‚úÖ `GET /geo/ufs` ‚Üí Lista todos os estados
  **Query**: `q` (opcional, busca parcial por nome ou sigla)
  **Resposta**:

  ```json
  {
    "success": true,
    "code": "OK",
    "data": [
      {
        "id": 26,
        "sigla": "PE",
        "nome": "Pernambuco",
        "regiao": {
          "id": 2,
          "sigla": "NE",
          "nome": "Nordeste"
        }
      }
    ]
  }
  ```

  **Fonte**: Seed local baseado em dados do IBGE.

* ‚úÖ `GET /geo/ufs/:sigla` ‚Üí Busca estado espec√≠fico pela sigla
  **Exemplo**: `/geo/ufs/PE`

* ‚úÖ `GET /geo/municipios` ‚Üí Lista todos os munic√≠pios
  **Query**: 
  - `uf` (opcional, filtra por estado)
  - `q` (opcional, busca por nome)
  
  **Exemplo**: `/geo/municipios?uf=PE&q=recife`

* ‚úÖ `GET /geo/municipios/:uf` ‚Üí Lista munic√≠pios de um estado
  **Exemplo**: `/geo/municipios/PE`
  **Resposta**: array de munic√≠pios com id (IBGE), nome, microrregi√£o, mesorregi√£o e regi√£o imediata/intermedi√°ria.

* ‚úÖ `GET /geo/municipios/id/:id` ‚Üí Busca munic√≠pio pelo c√≥digo IBGE
  **Exemplo**: `/geo/municipios/id/2611606` (Recife)

---

## üìã Endpoints planejados (futuro)

### CEP

* `GET /cep/{cep}` ‚Üí Busca informa√ß√µes de CEP
  **Fonte** prim√°ria: BrasilAPI. **Fallback**: ViaCEP. **Cache** agressivo (7‚Äì30d).

### Documentos & utilidades

* `POST /utils/cpf/validate` ‚Üí Validar CPF (offline)
* `POST /utils/cnpj/validate` ‚Üí Validar CNPJ (offline)
* `POST /utils/phone/format` ‚Üí Formatar telefone brasileiro
* `POST /utils/slugify` ‚Üí Gerar slug a partir de texto

### Neg√≥cio

* `GET /biz/bancos` ‚Üí Lista bancos ativos (c√≥digo, nome)
* `GET /biz/feriados/{ano}` ‚Üí Feriados nacionais e por UF

### GEO Avan√ßado

* `GET /geo/df/ras` ‚Üí Regi√µes Administrativas do DF (33 RAs)

---

## üìÆ Testando com Postman

Uma **collection completa do Postman** est√° dispon√≠vel para facilitar os testes:

- üìÅ `postman_collection.json` - Collection com todos os endpoints
- üåç `postman_environment.json` - Environment pr√©-configurado para localhost
- üìñ [POSTMAN.md](POSTMAN.md) - Guia completo de uso

### Features da Collection:

- ‚úÖ **50+ requisi√ß√µes** organizadas por categoria
- ‚úÖ **Auto-save de API Keys** - Scripts autom√°ticos salvam keys nas vari√°veis
- ‚úÖ **Exemplos de casos de uso** reais
- ‚úÖ **Documenta√ß√£o inline** em cada requisi√ß√£o
- ‚úÖ **Environment pr√©-configurado** para desenvolvimento local

[üëâ Ver guia completo do Postman](POSTMAN.md)

---

## üß∞ Exemplo de uso (cURL)

```bash
# Health check
curl -s 'http://localhost:8080/health' | jq

# Vers√£o da API
curl -s 'http://localhost:8080/version' | jq

# Listar todos os estados
curl -s 'http://localhost:8080/geo/ufs' | jq

# Buscar estado espec√≠fico
curl -s 'http://localhost:8080/geo/ufs/PE' | jq

# Buscar estados (filtro)
curl -s 'http://localhost:8080/geo/ufs?q=pernambuco' | jq

# Listar munic√≠pios de um estado
curl -s 'http://localhost:8080/geo/municipios/PE' | jq

# Buscar munic√≠pios por nome
curl -s 'http://localhost:8080/geo/municipios?uf=PE&q=recife' | jq

# Buscar munic√≠pio por c√≥digo IBGE
curl -s 'http://localhost:8080/geo/municipios/id/2611606' | jq

# Criar tenant
curl -X POST 'http://localhost:8080/tenants' \
  -H 'Content-Type: application/json' \
  -d '{"tenantId":"cliente-1","name":"Cliente Exemplo","email":"contato@exemplo.com","active":true}' | jq

# Criar API key
curl -X POST 'http://localhost:8080/apikeys' \
  -H 'Content-Type: application/json' \
  -d '{"tenantId":"cliente-1","name":"Chave Producao"}' | jq
```

---

## üß™ Contratos (OpenAPI)

A documenta√ß√£o completa est√° dispon√≠vel em:
- `/docs` - Interface Redoc
- `/openapi.yaml` - Especifica√ß√£o OpenAPI

### Exemplo de schema de resposta

```yaml
# Resposta de sucesso
SuccessResponse:
  type: object
  properties:
    success:
      type: boolean
      example: true
    code:
      type: string
      example: "OK"
    data:
      type: object
    meta:
      type: object

# Resposta de erro (RFC 7807)
ErrorResponse:
  type: object
  properties:
    type:
      type: string
      example: "https://retech-core/errors/not-found"
    title:
      type: string
      example: "Not Found"
    status:
      type: integer
      example: 404
    detail:
      type: string
      example: "Estado n√£o encontrado"
    instance:
      type: string
      example: "/geo/ufs/XX"
    traceId:
      type: string
```

---

## ‚öôÔ∏è Configura√ß√£o (ENV)

```bash
# Servidor
PORT=8080                              # Porta HTTP (padr√£o: 8080)
ENV=development                        # Ambiente: development | production

# MongoDB
MONGO_URI=mongodb://localhost:27017    # URI de conex√£o MongoDB
MONGO_DB=retech_core                   # Nome do banco de dados

# CORS
CORS_ENABLE=true                       # Habilita CORS (padr√£o: true)
```

### Exemplo de .env

```bash
PORT=8080
ENV=development
MONGO_URI=mongodb://mongo:27017
MONGO_DB=retech_core
CORS_ENABLE=true
```

---

## üíæ Migrations e Seeds

O sistema possui um gerenciador de migrations que executa automaticamente na inicializa√ß√£o da aplica√ß√£o.

### Como funciona

1. Na inicializa√ß√£o, o sistema verifica quais migrations ainda n√£o foram executadas
2. Executa as migrations pendentes em ordem
3. Registra cada migration executada na collection `migrations`
4. Seeds de estados e munic√≠pios s√£o carregados automaticamente se n√£o existirem

### Estrutura de dados

#### Estados (27 UFs)
- Seed: `seeds/estados.json`
- Collection: `estados`
- Total: 27 registros
- Fonte: IBGE

#### Munic√≠pios (5570 munic√≠pios)
- Seed: `seeds/municipios.json`
- Collection: `municipios`
- Total: 5570 registros
- Fonte: IBGE

### Localiza√ß√£o dos arquivos de seed

O sistema busca os arquivos JSON nas seguintes localiza√ß√µes:
1. `seeds/` (recomendado)
2. `~/Downloads/` (conveniente para desenvolvimento)
3. `data/`
4. Raiz do projeto

### Re-executar seeds

Para re-executar os seeds:

```bash
# Conectar ao MongoDB
mongo retech_core

# Remover registros de migration
db.migrations.deleteOne({version: "001_seed_estados"})
db.migrations.deleteOne({version: "002_seed_municipios"})

# Limpar dados (opcional)
db.estados.deleteMany({})
db.municipios.deleteMany({})

# Reiniciar a aplica√ß√£o
```

---

## üöÄ Deploy em Produ√ß√£o

### Railway (Recomendado) üöÇ

Deploy simplificado com MongoDB gerenciado e CI/CD autom√°tico:

- ‚úÖ **Deploy autom√°tico** via Git push
- ‚úÖ **MongoDB inclu√≠do** (ou use MongoDB Atlas)
- ‚úÖ **Seeds autom√°ticos** na primeira execu√ß√£o
- ‚úÖ **HTTPS gr√°tis** e dom√≠nio customiz√°vel
- ‚úÖ **Logs em tempo real**
- ‚úÖ **Free tier dispon√≠vel**

[üëâ Ver guia completo de deploy no Railway](RAILWAY_DEPLOY.md)

**Quick Start:**
```bash
# 1. Verificar se est√° pronto
./railway-check.sh

# 2. Commit seeds
git add seeds/*.json
git commit -m "chore: adicionar seeds para produ√ß√£o"
git push origin main

# 3. Deploy no Railway (via dashboard ou CLI)
railway up
```

**Arquivos de configura√ß√£o:**
- `Dockerfile.railway` - Dockerfile otimizado para produ√ß√£o
- `railway.json` / `railway.toml` - Configura√ß√£o Railway
- `railway.env.example` - Vari√°veis de ambiente

---

## üê≥ Deploy (Docker Local)

**Dockerfile (Go)**

```dockerfile
FROM golang:1.22 AS build
WORKDIR /src
COPY . .
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o /out/retech-core ./cmd/api

FROM gcr.io/distroless/base-debian12
COPY --from=build /out/retech-core /retech-core
EXPOSE 8080
USER nonroot:nonroot
ENTRYPOINT ["/retech-core"]
```

**docker-compose.yml (dev)**

```yaml
version: '3.9'
services:
  api:
    build: .
    ports: ["8080:8080"]
    env_file: .env
    depends_on: [redis]
  redis:
    image: redis:7-alpine
    ports: ["6379:6379"]
```

---

## üõ°Ô∏è Boas pr√°ticas

* **Timeouts** e **retries** exponenciais para upstreams.
* **Cache key** determin√≠stica e invalida√ß√£o por rota.
* **Schema validation** (ex.: go-playground/validator) em inputs.
* **E2E contract tests** (Dredd/Pact) para n√£o quebrar clientes.
* **Idempot√™ncia** em POSTs sens√≠veis (chave idempotency em header).

---

## üó∫Ô∏è Roadmap

### ‚úÖ Implementado

* [x] Sistema de migrations/seeds autom√°tico
* [x] Endpoints de estados (UFs) com busca
* [x] Endpoints de munic√≠pios com filtros por UF e nome
* [x] Gest√£o de tenants e API keys
* [x] Health check e vers√£o
* [x] Documenta√ß√£o OpenAPI/Redoc
* [x] √çndices MongoDB para performance

### üöß Em planejamento

#### Curto prazo
* [ ] Cache com Redis (estados e munic√≠pios)
* [ ] Rate limiting por API key
* [ ] Endpoints de CEP (integra√ß√£o BrasilAPI + ViaCEP)
* [ ] Middleware de autentica√ß√£o obrigat√≥ria em rotas protegidas

#### M√©dio prazo
* [ ] Validadores de CPF/CNPJ (offline)
* [ ] Formatador de telefone brasileiro
* [ ] Utilidades (slugify, normaliza√ß√£o)
* [ ] Endpoints de bancos (Bacen)
* [ ] Feriados nacionais e por UF

#### Longo prazo
* [ ] Regi√µes Administrativas do DF (33 RAs)
* [ ] CNAEs e naturezas jur√≠dicas
* [ ] Geocoding (Nominatim, rate-limit estrito)
* [ ] Endpoints bulk para grandes volumes
* [ ] Webhooks para invalida√ß√£o de cache
* [ ] Prometheus metrics
* [ ] OpenTelemetry traces

---

## üìÑ Licen√ßa

Definir conforme pol√≠tica interna (MIT/Propriet√°ria).

---

---

## üìö Estrutura do projeto

```
retech-core/
‚îú‚îÄ‚îÄ cmd/api/
‚îÇ   ‚îî‚îÄ‚îÄ main.go                    # Ponto de entrada da aplica√ß√£o
‚îú‚îÄ‚îÄ internal/
‚îÇ   ‚îú‚îÄ‚îÄ auth/                      # Middleware de autentica√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ bootstrap/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ indexes.go             # Cria√ß√£o de √≠ndices MongoDB
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ migrations.go          # Sistema de migrations/seeds
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ config.go              # Configura√ß√µes (env vars)
‚îÇ   ‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ apikey.go              # Modelo de API Keys
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ estado.go              # Modelo de Estados
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ municipio.go           # Modelo de Munic√≠pios
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tenant.go              # Modelo de Tenants
‚îÇ   ‚îú‚îÄ‚îÄ http/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ apikey.go          # Handlers de API keys
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ geo.go             # Handlers de GEO (estados/munic√≠pios)
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ health.go          # Health check
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tenant.go          # Handlers de tenants
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ version.go         # Vers√£o da API
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ router.go              # Configura√ß√£o de rotas
‚îÇ   ‚îú‚îÄ‚îÄ middleware/                # Middlewares HTTP
‚îÇ   ‚îú‚îÄ‚îÄ observability/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logger.go              # Logger estruturado (zerolog)
‚îÇ   ‚îî‚îÄ‚îÄ storage/
‚îÇ       ‚îú‚îÄ‚îÄ apikeys_repo.go        # Reposit√≥rio de API Keys
‚îÇ       ‚îú‚îÄ‚îÄ estados_repo.go        # Reposit√≥rio de Estados
‚îÇ       ‚îú‚îÄ‚îÄ mongo.go               # Cliente MongoDB
‚îÇ       ‚îú‚îÄ‚îÄ municipios_repo.go     # Reposit√≥rio de Munic√≠pios
‚îÇ       ‚îî‚îÄ‚îÄ tenants_repo.go        # Reposit√≥rio de Tenants
‚îú‚îÄ‚îÄ seeds/
‚îÇ   ‚îú‚îÄ‚îÄ estados.json               # Seed de estados (27 UFs)
‚îÇ   ‚îî‚îÄ‚îÄ municipios.json            # Seed de munic√≠pios (5570)
‚îú‚îÄ‚îÄ build/
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile                 # Dockerfile de produ√ß√£o
‚îÇ   ‚îî‚îÄ‚îÄ docker-compose.yml         # Compose para desenvolvimento
‚îî‚îÄ‚îÄ go.mod                         # Depend√™ncias Go
```

---

## üìù Notas de implementa√ß√£o

### Estados e Munic√≠pios
* Dados carregados via **seed autom√°tico** na inicializa√ß√£o
* Seeds baseados em dados oficiais do IBGE
* Sistema de migrations garante que seeds rodem apenas uma vez
* √çndices MongoDB otimizam buscas por ID, sigla e nome
* Busca por nome implementada como **filtro local** (case-insensitive)

### Tenants e API Keys
* Sistema multi-tenant implementado
* API Keys com suporte a rota√ß√£o e revoga√ß√£o
* Cada API key vinculada a um tenant espec√≠fico

### Observabilidade
* Logs estruturados com zerolog
* Health check integrado com MongoDB
* Vers√£o da API exposta via endpoint

### Performance
* √çndices √∫nicos: estados (id, sigla), munic√≠pios (id)
* √çndices de busca: munic√≠pios (nome, UF)
* Seeds carregados em lotes de 1000 para otimizar mem√≥ria
